generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum QuestStatus {
  ACTIVE
  COMPLETED
}

enum PairRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELED
}

model User {
  id              String   @id @db.VarChar(32)
  clientUserId    String?  @unique @db.VarChar(64)
  name            String   @db.VarChar(64)
  avatarUrl       String?  @db.Text
  homeCoupleId    String?  @db.VarChar(32)
  activeCoupleId  String?  @db.VarChar(32)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  homeCouple      Couple?  @relation("UserHomeCouple", fields: [homeCoupleId], references: [id])
  activeCouple    Couple?  @relation("UserActiveCouple", fields: [activeCoupleId], references: [id])
  createdCouples  Couple[] @relation("CreatorCouples")
  partnerCouples  Couple[] @relation("PartnerCouples")
  sentPairRequests     PairRequest[] @relation("PairRequestFromUser")
  receivedPairRequests PairRequest[] @relation("PairRequestToUser")
  notes           Note[]
  createdQuests   Quest[]  @relation("QuestCreatedBy")
  completedQuests Quest[]  @relation("QuestCompletedBy")
  moments         Moment[]
  cupidConversations CupidConversation[]

  @@index([homeCoupleId])
  @@index([activeCoupleId])
}

model Couple {
  id              String    @id @db.VarChar(32)
  pairCode        String    @unique @db.VarChar(6)
  creatorId       String    @unique @db.VarChar(32)
  partnerId       String?   @unique @db.VarChar(32)
  anniversaryDate DateTime? @db.Date
  intimacyScore   Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  creator         User      @relation("CreatorCouples", fields: [creatorId], references: [id])
  partner         User?     @relation("PartnerCouples", fields: [partnerId], references: [id])
  homeUsers       User[]    @relation("UserHomeCouple")
  activeUsers     User[]    @relation("UserActiveCouple")
  pairRequests    PairRequest[]
  notes           Note[]
  quests          Quest[]
  moments         Moment[]

  @@index([pairCode])
}

model PairRequest {
  id          String            @id @db.VarChar(32)
  coupleId    String            @db.VarChar(32)
  fromUserId  String            @db.VarChar(32)
  toUserId    String            @db.VarChar(32)
  status      PairRequestStatus @default(PENDING)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  respondedAt DateTime?

  couple      Couple @relation(fields: [coupleId], references: [id])
  fromUser    User   @relation("PairRequestFromUser", fields: [fromUserId], references: [id])
  toUser      User   @relation("PairRequestToUser", fields: [toUserId], references: [id])

  @@index([coupleId])
  @@index([toUserId, status, createdAt, id(sort: Desc)])
  @@index([fromUserId, status, createdAt, id(sort: Desc)])
}

model Note {
  id        String   @id @db.VarChar(32)
  coupleId  String   @db.VarChar(32)
  authorId  String   @db.VarChar(32)
  content   String   @db.Text
  color     String?  @db.VarChar(32)
  mediaUrl  String?  @db.Text
  mediaType String?  @db.VarChar(16)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  couple    Couple   @relation(fields: [coupleId], references: [id])
  author    User     @relation(fields: [authorId], references: [id])

  @@index([coupleId, createdAt, id(sort: Desc)])
  @@index([authorId])
}

model Quest {
  id          String      @id @db.VarChar(32)
  coupleId    String      @db.VarChar(32)
  title       String      @db.VarChar(120)
  description String?     @db.Text
  points      Int
  type        String      @db.VarChar(64)
  status      QuestStatus @default(ACTIVE)
  createdBy   String      @db.VarChar(32)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  completedAt DateTime?
  completedBy String?     @db.VarChar(32)
  couple      Couple      @relation(fields: [coupleId], references: [id])
  creator     User        @relation("QuestCreatedBy", fields: [createdBy], references: [id])
  completer   User?       @relation("QuestCompletedBy", fields: [completedBy], references: [id])

  @@index([coupleId, status, createdAt, id(sort: Desc)])
}

model Moment {
  id          String   @id @db.VarChar(32)
  coupleId    String   @db.VarChar(32)
  createdBy   String   @db.VarChar(32)
  title       String   @db.VarChar(120)
  description String?  @db.Text
  date        DateTime @db.Date
  imageUrl    String   @db.Text
  tags        String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  couple      Couple   @relation(fields: [coupleId], references: [id])
  creator     User     @relation(fields: [createdBy], references: [id])

  @@index([coupleId, createdAt, id(sort: Desc)])
  @@index([createdBy])
  @@index([tags], type: Gin)
}

model CupidConversation {
  id            String        @id @db.VarChar(32)
  userId        String        @db.VarChar(32)
  title         String        @db.VarChar(200)
  messageCount  Int           @default(0)
  lastMessageAt DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages CupidMessage[]

  @@index([userId, updatedAt, id(sort: Desc)])
}

model CupidMessage {
  id             String            @id @db.VarChar(32)
  conversationId String            @db.VarChar(32)
  seq            Int
  role           String            @db.VarChar(16)
  text           String            @db.Text
  timestampMs    BigInt?
  createdAt      DateTime          @default(now())

  conversation CupidConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, seq])
  @@index([conversationId, seq])
}
